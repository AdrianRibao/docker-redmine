#!/bin/bash

DB_HOST=${DB_HOST:-localhost}
DB_NAME=${DB_NAME:-redmine}
DB_USER=${DB_USER:-root}
DB_PASS=${DB_PASS:-}

# start supervisord
/usr/bin/supervisord

if [ "${DB_HOST}" == "localhost" ]; then
	mysql_install_db --user=mysql
	/usr/bin/mysqld_safe &
	sleep 3
fi

chmod -R 755 /redmine/files
chown -R www-data:www-data /redmine/files

cd /redmine
sed 's/{{DB_HOST}}/'${DB_HOST}'/' -i config/database.yml
sed 's/{{DB_NAME}}/'${DB_NAME}'/' -i config/database.yml
sed 's/{{DB_USER}}/'${DB_USER}'/' -i config/database.yml
sed 's/{{DB_PASS}}/'${DB_PASS}'/' -i config/database.yml

# isolate the plugins
mv plugins plugins-1

su www-data -m -c 'rake generate_secret_token'
su www-data -m -c 'RAILS_ENV=production rake db:create'
su www-data -m -c 'RAILS_ENV=production rake db:migrate'

mv plugins-1 plugins
su www-data -m -c 'RAILS_ENV=production rake redmine:plugins:migrate'

/usr/sbin/apache2
tail -F /var/log/apache2/other_vhosts_access.log
